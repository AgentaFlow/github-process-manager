name: MLOps Deployment Documentation

on:
  workflow_dispatch:
    inputs:
      model_name:
        description: 'Model name'
        required: true
        type: string
      model_version:
        description: 'Model version to deploy (semver format: X.Y.Z)'
        required: true
        type: string
      deployment_target:
        description: 'Target deployment environment'
        required: true
        type: choice
        options:
          - staging
          - production
          - canary
          - development
        default: 'staging'
      deployment_strategy:
        description: 'Deployment strategy'
        required: false
        type: choice
        options:
          - blue-green
          - canary
          - rolling
          - shadow
        default: 'canary'
      deployment_config:
        description: 'Additional deployment configuration (JSON format)'
        required: false
        type: string
        default: '{}'

jobs:
  generate-deployment-docs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --no-cache-dir python-docx

      - name: Generate Deployment Documentation
        run: |
          python3 << 'EOF'
          import json
          import os
          from datetime import datetime
          from docx import Document
          from docx.shared import Inches, Pt, RGBColor
          from docx.enum.text import WD_ALIGN_PARAGRAPH

          # Get workflow inputs
          model_name = "${{ inputs.model_name }}"
          model_version = "${{ inputs.model_version }}"
          deployment_target = "${{ inputs.deployment_target }}"
          deployment_strategy = "${{ inputs.deployment_strategy }}"
          deployment_config = """${{ inputs.deployment_config }}"""

          # Parse configuration
          try:
              config = json.loads(deployment_config) if deployment_config and deployment_config != '{}' else {}
          except json.JSONDecodeError:
              config = {}

          # Create document
          doc = Document()
          
          # Set default font
          style = doc.styles['Normal']
          font = style.font
          font.name = 'Calibri'
          font.size = Pt(11)

          # Add header
          header = doc.sections[0].header
          header_para = header.paragraphs[0]
          header_para.text = "GitHub Process Manager | MLOps Deployment Documentation"
          header_para.alignment = WD_ALIGN_PARAGRAPH.CENTER
          header_run = header_para.runs[0]
          header_run.font.size = Pt(10)
          header_run.font.color.rgb = RGBColor(74, 144, 226)  # Light blue

          # Add title
          title = doc.add_heading('Model Deployment Plan', 0)
          title.alignment = WD_ALIGN_PARAGRAPH.CENTER

          # Add metadata
          doc.add_paragraph(f"Model Name: {model_name}", style='Body Text')
          doc.add_paragraph(f"Model Version: {model_version}", style='Body Text')
          doc.add_paragraph(f"Target Environment: {deployment_target.upper()}", style='Body Text')
          doc.add_paragraph(f"Deployment Strategy: {deployment_strategy.title()}", style='Body Text')
          doc.add_paragraph(f"Deployment Date: {datetime.now().strftime('%Y-%m-%d')}", style='Body Text')
          doc.add_paragraph()  # Blank line

          # Section 1: Model Overview
          doc.add_heading('1. Model Overview', 1)
          doc.add_paragraph(f"Model: {model_name}")
          doc.add_paragraph(f"Version: {model_version}")
          doc.add_paragraph(f"Deployment Target: {deployment_target} environment")
          doc.add_paragraph()
          doc.add_paragraph("Model Purpose:")
          doc.add_paragraph("This deployment plan outlines the strategy, prerequisites, and procedures for deploying the model to the target environment.")
          doc.add_paragraph()

          # Section 2: Data Pipeline
          doc.add_heading('2. Data Pipeline', 1)
          doc.add_paragraph("Data pipeline configuration for deployment:")
          doc.add_paragraph("â€¢ Input data source: Production data stream")
          doc.add_paragraph("â€¢ Data preprocessing: Real-time feature engineering pipeline")
          doc.add_paragraph("â€¢ Data validation: Schema validation and quality checks enabled")
          doc.add_paragraph("â€¢ Feature store: Integration with feature repository")
          doc.add_paragraph()

          # Section 3: Training Process
          doc.add_heading('3. Training Process', 1)
          doc.add_paragraph("Model training summary:")
          doc.add_paragraph(f"â€¢ Model Version: {model_version}")
          doc.add_paragraph("â€¢ Training completed: Pre-deployment validation passed")
          doc.add_paragraph("â€¢ Model registry: Registered and approved for deployment")
          doc.add_paragraph("â€¢ Artifacts: Model weights, configuration, and metadata stored")
          doc.add_paragraph()

          # Section 4: Validation Results
          doc.add_heading('4. Validation Results', 1)
          doc.add_paragraph("Pre-deployment validation status:")
          doc.add_paragraph("âœ“ Model validation completed successfully")
          doc.add_paragraph("âœ“ Performance metrics meet deployment criteria")
          doc.add_paragraph("âœ“ Security scan passed")
          doc.add_paragraph("âœ“ Integration tests passed")
          doc.add_paragraph()
          
          if config:
              doc.add_paragraph("Additional Configuration:")
              for key, value in config.items():
                  doc.add_paragraph(f"â€¢ {key}: {value}")
              doc.add_paragraph()

          # Section 5: Deployment Plan
          doc.add_heading('5. Deployment Plan', 1)
          
          doc.add_paragraph(f"Deployment Strategy: {deployment_strategy.title()}")
          doc.add_paragraph()
          
          # Strategy-specific details
          if deployment_strategy == 'canary':
              doc.add_paragraph("Canary Deployment Steps:")
              doc.add_paragraph("1. Deploy to canary environment (10% traffic)")
              doc.add_paragraph("2. Monitor for 1 hour: error rates, latency, accuracy")
              doc.add_paragraph("3. If successful, increase to 50% traffic")
              doc.add_paragraph("4. Monitor for 2 hours")
              doc.add_paragraph("5. If successful, deploy to 100% traffic")
              doc.add_paragraph("6. Continue enhanced monitoring for 24 hours")
          elif deployment_strategy == 'blue-green':
              doc.add_paragraph("Blue-Green Deployment Steps:")
              doc.add_paragraph("1. Deploy model to green environment")
              doc.add_paragraph("2. Validate green environment functionality")
              doc.add_paragraph("3. Run smoke tests on green environment")
              doc.add_paragraph("4. Switch traffic from blue to green")
              doc.add_paragraph("5. Monitor green environment performance")
              doc.add_paragraph("6. Keep blue environment for rollback (24 hours)")
          elif deployment_strategy == 'rolling':
              doc.add_paragraph("Rolling Deployment Steps:")
              doc.add_paragraph("1. Deploy to first pod/instance")
              doc.add_paragraph("2. Validate health checks")
              doc.add_paragraph("3. Gradually roll out to remaining pods")
              doc.add_paragraph("4. Monitor each stage for issues")
              doc.add_paragraph("5. Complete deployment across all instances")
          elif deployment_strategy == 'shadow':
              doc.add_paragraph("Shadow Deployment Steps:")
              doc.add_paragraph("1. Deploy new model alongside current model")
              doc.add_paragraph("2. Duplicate traffic to both models")
              doc.add_paragraph("3. Compare predictions (do not serve new model)")
              doc.add_paragraph("4. Analyze performance differences")
              doc.add_paragraph("5. After validation, switch to new model")
          
          doc.add_paragraph()
          doc.add_paragraph("Pre-Deployment Checklist:")
          doc.add_paragraph("â˜ Model artifacts uploaded to registry")
          doc.add_paragraph("â˜ Configuration files reviewed")
          doc.add_paragraph("â˜ Monitoring dashboards configured")
          doc.add_paragraph("â˜ Alerts configured for key metrics")
          doc.add_paragraph("â˜ Rollback procedure documented and tested")
          doc.add_paragraph("â˜ Stakeholders notified of deployment")
          doc.add_paragraph()
          
          doc.add_paragraph("Post-Deployment Monitoring:")
          doc.add_paragraph("â€¢ Monitor error rates (target: < 1%)")
          doc.add_paragraph("â€¢ Monitor latency P95 (target: < 100ms)")
          doc.add_paragraph("â€¢ Monitor prediction accuracy")
          doc.add_paragraph("â€¢ Monitor resource utilization (CPU, memory)")
          doc.add_paragraph("â€¢ Enhanced monitoring for first 48 hours")
          doc.add_paragraph()
          
          doc.add_paragraph("Rollback Plan:")
          doc.add_paragraph(f"â€¢ Previous version available for immediate rollback")
          doc.add_paragraph("â€¢ Rollback triggers: Error rate > 5%, Latency > 2x baseline")
          doc.add_paragraph("â€¢ Rollback execution time: < 5 minutes")
          doc.add_paragraph("â€¢ Rollback testing: Verified in staging environment")

          # Footer
          footer = doc.sections[0].footer
          footer_para = footer.paragraphs[0]
          footer_para.text = f"Generated by GitHub Actions â€¢ {datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')}"
          footer_para.alignment = WD_ALIGN_PARAGRAPH.CENTER
          footer_run = footer_para.runs[0]
          footer_run.font.size = Pt(9)
          footer_run.font.color.rgb = RGBColor(128, 128, 128)

          # Save document
          filename = f"mlops-deployment-{model_name.replace(' ', '-')}-v{model_version}-{deployment_target}.docx"
          doc.save(filename)
          print(f"Generated deployment plan: {filename}")
          
          # Set output for artifact name
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"filename={filename}\n")
          EOF

      - name: Upload Deployment Documentation
        uses: actions/upload-artifact@v4
        with:
          name: mlops-deployment-docs
          path: mlops-deployment-*.docx
          retention-days: 90

      - name: Summary
        run: |
          echo "## MLOps Deployment Documentation Generated âœ“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Model:** ${{ inputs.model_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ inputs.model_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** ${{ inputs.deployment_target }}" >> $GITHUB_STEP_SUMMARY
          echo "**Strategy:** ${{ inputs.deployment_strategy }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ Download the deployment plan from the artifacts section above." >> $GITHUB_STEP_SUMMARY
